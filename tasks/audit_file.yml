---
- name: Calculate hash of local reference file (SoT)
  delegate_to: localhost
  stat:
    path: "{{ playbook_dir }}/source_of_truth/{{ audit_item.src }}"
    checksum_algorithm: sha256
  register: local_ref_stat

- name: Fail if local reference file is missing
  fail:
    msg: "Local reference file not found: {{ playbook_dir }}/source_of_truth/{{ audit_item.src }}"
  when: not local_ref_stat.stat.exists

- name: Get hash of remote configuration file
  stat:
    path: "{{ audit_item.dest }}"
    checksum_algorithm: sha256
  register: remote_file_stat

- name: Initialize drift status
  set_fact:
    drift_detected: false
    drift_type: "none"

- name: Check for Drift (Missing File)
  set_fact:
    drift_detected: true
    drift_type: "missing"
  when: not remote_file_stat.stat.exists

- name: Check for Drift (Content Mismatch)
  set_fact:
    drift_detected: true
    drift_type: "modified"
  when: 
    - remote_file_stat.stat.exists
    - local_ref_stat.stat.checksum != remote_file_stat.stat.checksum

- name: Check for Drift (Metadata Mismatch)
  set_fact:
    drift_detected: true
    drift_type: "metadata"
  when: 
    - remote_file_stat.stat.exists
    - (audit_item.mode is defined and remote_file_stat.stat.mode != audit_item.mode) or
      (audit_item.owner is defined and remote_file_stat.stat.pw_name != audit_item.owner) or
      (audit_item.group is defined and remote_file_stat.stat.gr_name != audit_item.group)
    - drift_type == "none" # Content drift takes precedence for simplicity, or remove this to detect both

# --- DIFF SECTION ---
- name: Fetch remote file for diff (if modified)
  fetch:
    src: "{{ audit_item.dest }}"
    dest: "/tmp/ansible_drift_{{ inventory_hostname }}_fetched"
    flat: yes
  when: drift_detected and drift_type == 'modified'

- name: Decrypt Source of Truth to Temp File
  delegate_to: localhost
  copy:
    src: "{{ playbook_dir }}/source_of_truth/{{ audit_item.src }}"
    dest: "/tmp/ansible_drift_sot_{{ inventory_hostname }}_decrypted"
    mode: '0600'
  when: drift_detected and drift_type == 'modified'
  ignore_errors: true
  register: decrypt_result

- name: Handle Decryption Failure
  set_fact:
    drift_type: "vault_error"
  when: 
    - drift_detected 
    - drift_type == 'modified'
    - decrypt_result.failed

- name: Generate Diff
  delegate_to: localhost
  shell: "diff -U 0 '/tmp/ansible_drift_sot_{{ inventory_hostname }}_decrypted' '/tmp/ansible_drift_{{ inventory_hostname }}_fetched' | grep -vE '^(---|\\+\\+\\+|@@)' || true"
  register: diff_output
  changed_when: false
  when: drift_detected and drift_type == 'modified'

- name: Cleanup Decrypted Source of Truth
  delegate_to: localhost
  file:
    path: "/tmp/ansible_drift_sot_{{ inventory_hostname }}_decrypted"
    state: absent
  when: drift_detected and drift_type == 'modified'

- name: Display Diff
  debug:
    msg: |
      ⚠️  DRIFT DETECTED on {{ inventory_hostname }}
      File: {{ audit_item.dest }}
      --- DIFF OUTPUT ---
      {{ diff_output.stdout }}
  when: drift_detected and drift_type == 'modified'

- name: Display Vault Error
  debug:
    msg: |
      ⚠️  VAULT ERROR on {{ inventory_hostname }}
      File: {{ audit_item.dest }}
      Error: Source file is encrypted but Vault password was missing or incorrect.
  when: drift_detected and drift_type == 'vault_error'

- name: Display Metadata Drift
  debug:
    msg: |
      ⚠️  METADATA DRIFT on {{ inventory_hostname }}
      File: {{ audit_item.dest }}
      Expected: Mode={{ audit_item.mode | default('ANY') }}, Owner={{ audit_item.owner | default('ANY') }}, Group={{ audit_item.group | default('ANY') }}
      Found:    Mode={{ remote_file_stat.stat.mode }}, Owner={{ remote_file_stat.stat.pw_name }}, Group={{ remote_file_stat.stat.gr_name }}
  when: drift_detected and drift_type == 'metadata'

- name: Display Missing File Warning
  debug:
    msg: "⚠️  FILE MISSING on {{ inventory_hostname }}: {{ audit_item.dest }}"
  when: drift_detected and drift_type == 'missing'

# --- FIX SECTION ---
- name: Ask for confirmation to fix drift
  pause:
    prompt: "Drift detected ({{ drift_type }}) on {{ inventory_hostname }} for {{ audit_item.dest }}. Restore/Overwrite with SoT? (y/n)"
  register: prompt_result
  when: 
    - drift_detected
    - ask_fix | default(false) | bool
    - not (auto_fix | default(false) | bool)

- name: Determine if fix should be applied
  set_fact:
    should_fix: "{{ (auto_fix | default(false) | bool) or (prompt_result.user_input | default('n') | trim | lower == 'y') }}"
  when: drift_detected

- name: Apply Source of Truth (Fix Drift - Content or Missing)
  copy:
    src: "{{ playbook_dir }}/source_of_truth/{{ audit_item.src }}"
    dest: "{{ audit_item.dest }}"
    mode: "{{ audit_item.mode | default(omit) }}"
    owner: "{{ audit_item.owner | default(omit) }}"
    group: "{{ audit_item.group | default(omit) }}"
  when: 
    - drift_detected
    - should_fix | default(false) | bool
    - drift_type in ['modified', 'missing']

- name: Apply Source of Truth (Fix Drift - Metadata Only)
  file:
    path: "{{ audit_item.dest }}"
    mode: "{{ audit_item.mode | default(omit) }}"
    owner: "{{ audit_item.owner | default(omit) }}"
    group: "{{ audit_item.group | default(omit) }}"
  when: 
    - drift_detected
    - should_fix | default(false) | bool
    - drift_type == 'metadata'
    - remote_file_stat.stat.exists

# --- LOGGING SECTION ---
- name: Get current timestamp
  delegate_to: localhost
  command: date "+%Y-%m-%d %H:%M:%S"
  register: current_date
  changed_when: false
  run_once: true

- name: Log Audit Result (Drift Detected - Not Fixed)
  delegate_to: localhost
  throttle: 1
  lineinfile:
    path: "{{ playbook_dir }}/audit_history.log"
    create: yes
    line: "[{{ current_date.stdout }}] [DRIFT] Host: {{ inventory_hostname }} | File: {{ audit_item.dest }} | Type: {{ drift_type }} | Ref: {{ audit_item.src }}"
  when: 
    - drift_detected
    - not (should_fix | default(false) | bool)

- name: Log Audit Result (Drift Fixed)
  delegate_to: localhost
  throttle: 1
  lineinfile:
    path: "{{ playbook_dir }}/audit_history.log"
    create: yes
    line: "[{{ current_date.stdout }}] [FIXED] Host: {{ inventory_hostname }} | File: {{ audit_item.dest }} | Type: {{ drift_type }} | Ref: {{ audit_item.src }}"
  when: 
    - drift_detected
    - should_fix | default(false) | bool

- name: Log Audit Result (Success)
  delegate_to: localhost
  throttle: 1
  lineinfile:
    path: "{{ playbook_dir }}/audit_history.log"
    create: yes
    line: "[{{ current_date.stdout }}] [OK]    Host: {{ inventory_hostname }} | File: {{ audit_item.dest }}"
  when: not drift_detected

- name: Register Audit Result for Report
  set_fact:
    current_file_result:
      path: "{{ audit_item.dest }}"
      drift: "{{ drift_detected }}"
      drift_type: "{{ drift_type }}"
      diff_lines: "{{ diff_output.stdout_lines | default([]) }}"
      expected_meta: "Mode={{ audit_item.mode | default('ANY') }}, Owner={{ audit_item.owner | default('ANY') }}, Group={{ audit_item.group | default('ANY') }}"
      found_meta: "Mode={{ remote_file_stat.stat.mode | default('N/A') }}, Owner={{ remote_file_stat.stat.pw_name | default('N/A') }}, Group={{ remote_file_stat.stat.gr_name | default('N/A') }}"

- name: Append to Host Results
  set_fact:
    host_audit_results: "{{ host_audit_results | default([]) + [current_file_result] }}"

